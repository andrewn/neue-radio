<!DOCTYPE html>
<html>

<head>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <h1>App manager (internal)</h1>
  <div id="apps"></div>
  <script>
    let instances, apps;

    setTimeout(init, 3000);

    async function init() {
      console.log('Create apps...');
      apps = await getApps();
      instances = openApps(apps);
      console.log('...done');
    }

    async function getApps() {
      const config = await fetch('/apps').then(res => res.json());
      return config.apps;
    }

    function openApps(apps) {
      const rootElement = document.querySelector('#apps');

      const instances = apps.map(function (app) {
        const url = new URL(window.location);
        url.pathname = app;

        return mountAppUrlAtRoot(app, url, rootElement);
      });
      return instances;
    }

    function mountAppUrlAtRoot(id, url, rootElement) {
      const container = document.createElement('div');
      container.classList.add('app');

      container.innerHTML = `
        <div class="meta">
          <div class="id">${id}</div>
          <button class="reload">Reload</button>
        </div>
        <iframe class="instance" src="${url}" data-app-id="${id}" />
      `;

      const iframe = container.querySelector('iframe');
      iframe.addEventListener('load', () => {
        iframe.contentWindow.addEventListener('unload', () => container.classList.remove('is-loaded'))
        container.classList.add('is-loaded');
      });

      container.querySelector('.reload').addEventListener('click', () => {
        iframe.contentWindow.location.reload();
      });

      rootElement.appendChild(container);
      return container;
    }
  </script>
</body>

</html>
